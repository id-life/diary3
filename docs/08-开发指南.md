# 开发指南

## 环境准备

### 系统要求

- Node.js 18+ (推荐 20+)
- pnpm 10.0.0+

### 安装 pnpm

```bash
npm install -g pnpm@10
```

### 安装依赖

```bash
cd diary3
pnpm install
```

## 开发命令

```bash
# 启动开发服务器 (http://localhost:3000)
pnpm dev

# 生产构建
pnpm build

# 启动生产服务器
pnpm start

# 代码检查
pnpm lint
```

## 项目配置文件

### TypeScript 配置 (tsconfig.json)

关键配置：
- 路径别名：`@/*` 映射到 `./src/*`
- 目标：ES2017
- 严格模式：启用

```json
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

### Next.js 配置 (next.config.mjs)

关键配置：
- React Strict Mode：禁用（避免双重渲染）
- SVG 支持：使用 @svgr/webpack
- Million.js：已集成但禁用

### Tailwind 配置 (tailwind.config.js)

自定义配置：
- 深色模式：`class` 策略
- 自定义颜色：diary, purple, blue 等
- 自定义断点：xs, mobile, tablet, desktop

## 代码规范

### ESLint 配置

基于 `next/core-web-vitals`，关闭了部分规则：
- `@typescript-eslint/no-explicit-any`
- `@typescript-eslint/ban-types`
- `@typescript-eslint/no-unused-vars`

### Prettier 配置

```javascript
// .prettierrc.js
module.exports = {
  semi: true,
  singleQuote: true,
  printWidth: 120,
  tabWidth: 2,
  trailingComma: 'es5',
};
```

### Git Hooks (Husky + lint-staged)

提交前自动格式化：

```json
{
  "lint-staged": {
    "src/**/*.{js,jsx,ts,tsx,json,css,scss,md}": [
      "prettier --write"
    ]
  }
}
```

## 常见开发任务

### 添加新页面

1. 在 `src/app/` 下创建目录和 `page.tsx`
2. 如需保护，放在 `(protected)` 目录下
3. 添加导航链接到 `Navbar.tsx`

```typescript
// src/app/(protected)/new-page/page.tsx
export default function NewPage() {
  return <div>New Page Content</div>;
}
```

### 添加新原子 (Jotai)

1. 在 `src/atoms/` 下创建或修改文件
2. 在 `src/atoms/index.ts` 中导出

```typescript
// src/atoms/myFeature.ts
import { atom } from 'jotai';

export const myDataAtom = atom<string>('initial');

export const updateMyDataAtom = atom(
  null,
  (get, set, newValue: string) => {
    set(myDataAtom, newValue);
  }
);
```

### 添加新组件

1. 在 `src/components/` 对应目录下创建文件
2. 遵循现有命名规范

```typescript
// src/components/entry/MyComponent.tsx
import { useAtomValue } from 'jotai';
import { someAtom } from '@/atoms';

export const MyComponent = () => {
  const data = useAtomValue(someAtom);
  return <div>{data}</div>;
};
```

### 添加新 API 调用

1. 在 `src/api/` 下添加函数
2. 使用 `request` 实例

```typescript
// src/api/myApi.ts
import request from './request';

export const fetchMyData = (): Promise<MyData> => {
  return request.get('/my-endpoint');
};
```

### 添加新 Hook

```typescript
// src/hooks/useMyFeature.ts
import { useAtom } from 'jotai';
import { myDataAtom } from '@/atoms';

export const useMyFeature = () => {
  const [data, setData] = useAtom(myDataAtom);

  const doSomething = () => {
    setData('new value');
  };

  return { data, doSomething };
};
```

## 调试技巧

### 查看 Jotai 状态

```typescript
// 在组件中
import { useAtomValue } from 'jotai';
import { entryTypesArrayAtom } from '@/atoms';

const entryTypes = useAtomValue(entryTypesArrayAtom);
console.log('Entry Types:', entryTypes);
```

### 查看 localStorage

```javascript
// 在浏览器控制台
localStorage.getItem('entryTypes.entryTypesArray');
JSON.parse(localStorage.getItem('entryInstances.entryInstancesMap'));
```

### React Query DevTools

项目已集成 React Query，可在开发时查看请求状态。

## 样式开发

### 使用 Tailwind

```tsx
<div className="p-4 bg-white rounded-lg shadow-md">
  <h1 className="text-xl font-bold text-diary-primary">标题</h1>
</div>
```

### 使用 cn() 合并类名

```tsx
import { cn } from '@/utils';

<div className={cn(
  'base-class',
  isActive && 'active-class',
  className  // 允许外部覆盖
)} />
```

### 自定义主题色

使用 CSS 变量：

```css
/* src/styles/globals.css */
:root {
  --gradient-home-from: theme('colors.purple');
}

.diary-theme-1 {
  --gradient-home-from: #ff5912;
}
```

## 表单开发

### 使用 React Hook Form + Zod

```tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const schema = z.object({
  title: z.string().min(1, '必填'),
  points: z.number().min(0),
});

type FormData = z.infer<typeof schema>;

function MyForm() {
  const form = useForm<FormData>({
    resolver: zodResolver(schema),
    defaultValues: { title: '', points: 0 },
  });

  return (
    <form onSubmit={form.handleSubmit(onSubmit)}>
      <input {...form.register('title')} />
      {form.formState.errors.title && (
        <span>{form.formState.errors.title.message}</span>
      )}
    </form>
  );
}
```

## 测试数据

### 使用示例数据

```typescript
// src/entry/sample-state.json 包含示例数据
import sampleState from '@/entry/sample-state.json';
```

### 重置 localStorage

```javascript
// 浏览器控制台
localStorage.clear();
location.reload();
```

## 常见问题

### Hydration 错误

使用 `ClientOnly` 包装依赖客户端 API 的组件：

```tsx
import { ClientOnly } from '@/components/common/ClientOnly';

<ClientOnly>
  <ComponentUsingLocalStorage />
</ClientOnly>
```

### localStorage 不同步

确保使用 `atomWithStorage` 而不是直接操作 localStorage。

### 图标不显示

确认从正确的库导入：

```tsx
import { Home } from 'lucide-react';  // lucide-react
import { AiOutlineHome } from 'react-icons/ai';  // react-icons
```

## 构建和部署

### 生产构建

```bash
pnpm build
```

构建输出在 `.next/` 目录。

### 环境变量

生产环境需要设置：

```bash
NEXT_PUBLIC_API_PREFIX=https://diary-api.id.life
```

### 部署平台

推荐使用 Vercel 部署，自动处理 Next.js 优化。
