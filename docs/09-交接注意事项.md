# 交接注意事项

## 项目当前状态

### 已完成的工作

1. **依赖清理**（Phase 1）
   - 移除了 9 个未使用的依赖
   - 清理了 CRA 遗留配置

2. **认证系统统一**（Phase 2）
   - 移除了旧的手动 Token 认证
   - 统一使用 GitHub OAuth

3. **状态管理迁移**（Phase 3）
   - 从 Redux 完全迁移到 Jotai
   - 创建了备份数据转换器
   - 13 个组件已迁移

### 待完成的工作

1. **Phase 4: localStorage 冲突修复**
   - 存在直接 localStorage 写入绕过状态管理的情况
   - 需要统一存储抽象层

2. **Phase 5: 死代码清理**
   - GithubStorage.ts 有大量注释代码
   - 部分未使用的工具函数

3. **Phase 6: 测试验证**
   - 缺少单元测试
   - 需要端到端测试验证数据完整性

4. **Phase 7: 最终完善**
   - 文档更新
   - 安全审计
   - 性能优化

详情见 `REFACTORING_PLAN.md`。

## 关键决策记录

### 为什么使用 Jotai 而不是 Redux？

- 更简单的 API，减少样板代码
- 更好的 TypeScript 支持
- 更细粒度的订阅，性能更好
- 与 React 18+ 更好的集成

### 为什么禁用 React Strict Mode？

- 避免开发时的双重渲染问题
- 某些第三方库与 Strict Mode 不兼容

### 为什么禁用 Million.js？

- 虽然已集成，但发现与某些组件不兼容
- 性能提升不明显，决定暂时禁用

## 核心业务逻辑

### 积分计算

每个习惯有 `defaultPoints`，完成一次获得对应积分。积分可以在完成时调整，步长为 `pointStep`。

### 连续记录 (Streaks) 计算

- **Daily**: 连续每天完成
- **Weekly**: 连续每周完成（周内任一天完成即可）
- **Monthly**: 连续每月完成
- **Adhoc**: 不计算连续

计算逻辑在 `src/utils/entry.ts`。

### 日期处理

- 使用 dayjs 处理日期
- 日期字符串格式：`YYYY-MM-DD`
- 时间戳使用毫秒

## 已知问题

### 1. GithubLoadDialog 功能受限

旧的加载备份功能在认证迁移后暂时禁用，显示需要 OAuth 认证的提示。

### 2. localStorage 直接访问

部分代码直接操作 localStorage 而不是通过 Jotai 原子，可能导致状态不同步。

### 3. 类型安全

部分地方使用了 `any` 类型，TypeScript 类型覆盖不完整。

## 敏感信息

### 环境变量

```bash
NEXT_PUBLIC_API_PREFIX=https://diary-api.id.life
```

### localStorage 存储键

| 键名 | 内容 |
|------|------|
| `auth_token` | OAuth Token（敏感） |
| `entryTypes.entryTypesArray` | 习惯类型数据 |
| `entryInstances.entryInstancesMap` | 条目实例数据 |
| `reminderRecords.reminderRecords` | 提醒记录数据 |

## 依赖关系

### 后端服务

- API 服务：`https://diary-api.id.life`
- GitHub OAuth 需要后端配置回调 URL

### 第三方服务

- GitHub OAuth（用户认证）
- GitHub API（数据备份存储）

## 建议优先处理

### 高优先级

1. **添加测试**：核心业务逻辑（积分计算、连续记录）需要单元测试
2. **类型完善**：消除 `any` 类型，提高类型安全

### 中优先级

1. **清理死代码**：移除注释掉的代码块
2. **统一 localStorage 访问**：所有存储操作通过 Jotai 原子

### 低优先级

1. **性能优化**：分析和优化构建大小
2. **文档完善**：API 文档、组件文档

## 联系方式和资源

### 相关文档

- `CLAUDE.md`：Claude Code 使用指南
- `REFACTORING_PLAN.md`：重构计划和进度
- `README.md`：项目基本说明

### 代码库

- 主分支：`main`
- 代码仓库：（请填写）

### 后端相关

- 后端 API 仓库：（请填写）
- 部署文档：（请填写）

## 快速上手清单

- [ ] 克隆代码库
- [ ] 安装 pnpm 10+
- [ ] 运行 `pnpm install`
- [ ] 创建 `.env.local` 配置环境变量
- [ ] 运行 `pnpm dev` 启动开发服务器
- [ ] 阅读 `REFACTORING_PLAN.md` 了解项目状态
- [ ] 熟悉 `src/atoms/` 状态管理结构
- [ ] 熟悉 `src/entry/types-constants.ts` 数据模型

## 常用文件快速索引

| 需求 | 文件位置 |
|------|----------|
| 数据类型定义 | `src/entry/types-constants.ts` |
| 状态管理 | `src/atoms/` |
| 认证逻辑 | `src/hooks/useGitHubOAuth.ts` |
| API 配置 | `src/api/request.ts` |
| 页面路由 | `src/app/` |
| 全局样式 | `src/styles/globals.css` |
| 工具函数 | `src/utils/` |
