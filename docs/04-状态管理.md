# 状态管理

项目使用 **Jotai** 作为主要状态管理方案。所有状态相关代码位于 `src/atoms/` 目录下。

## 架构概览

```
                    ┌─────────────────────────────────┐
                    │         React Components        │
                    └─────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │          Jotai Atoms          │
                    │    (读取原子 / 写入原子)       │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │      hybridAtom (混合型)       │
                    │   (atomWithStorage)           │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │         localStorage          │
                    └───────────────────────────────┘
```

## 原子文件结构

```
src/atoms/
├── index.ts              # 导出入口
├── databaseFirst.ts      # 核心数据原子（localStorage 同步）
├── entryTypes.ts         # 习惯类型 CRUD 原子
├── entryInstances.ts     # 条目实例 CRUD 原子
├── reminderRecords.ts    # 提醒记录 CRUD 原子
├── app.ts                # 应用级状态原子
├── user.ts               # 用户认证状态原子
├── uiState.ts            # UI 状态原子
└── chart.ts              # 图表计算原子
```

## 核心原子详解

### 1. databaseFirst.ts - 混合型原子

这是数据持久化的核心，使用 `atomWithStorage` 实现 localStorage 同步：

```typescript
import { atomWithStorage } from 'jotai/utils';

// 习惯类型数据
export const hybridEntryTypesAtom = atomWithStorage<EntryType[]>(
  'entryTypes.entryTypesArray',  // localStorage 键名
  []                              // 默认值
);

// 条目实例数据
export const hybridEntryInstancesAtom = atomWithStorage<EntryInstancesMap>(
  'entryInstances.entryInstancesMap',
  {}
);

// 提醒记录数据
export const hybridReminderRecordsAtom = atomWithStorage<ReminderRecord[]>(
  'reminderRecords.reminderRecords',
  []
);

// UI 状态
export const hybridUiStateAtom = atomWithStorage<UIState>(
  'uiState.uiState',
  defaultUIState
);

// 旧版登录用户（兼容性）
export const legacyLoginUserAtom = atomWithStorage<any>(
  'loginUser.loginUser',
  null
);
```

### 2. entryTypes.ts - 习惯类型原子

```typescript
// 数据原子（引用 hybridEntryTypesAtom）
export const entryTypesArrayAtom = hybridEntryTypesAtom;

// 创建习惯
export const createEntryTypeAtom = atom(
  null,
  (get, set, entryType: EntryType) => {
    const current = get(entryTypesArrayAtom);
    set(entryTypesArrayAtom, [...current, entryType]);
    toast.success(`Create ${entryType.title} successfully`);
  }
);

// 更新习惯
export const updateEntryTypeAtom = atom(
  null,
  (get, set, entryType: EntryType) => {
    const current = get(entryTypesArrayAtom);
    const index = current.findIndex(et => et.id === entryType.id);
    if (index >= 0) {
      const updated = [...current];
      updated[index] = entryType;
      set(entryTypesArrayAtom, updated);
    }
  }
);

// 删除习惯
export const deleteEntryTypeAtom = atom(
  null,
  (get, set, entryTypeId: string) => {
    const current = get(entryTypesArrayAtom);
    set(entryTypesArrayAtom, current.filter(et => et.id !== entryTypeId));
  }
);

// 计算原子：获取所有 ID
export const entryTypeIdsAtom = atom((get) => {
  return get(entryTypesArrayAtom).map(et => et.id);
});
```

### 3. entryInstances.ts - 条目实例原子

```typescript
// 数据原子（按日期分组的 Map）
export const entryInstancesMapAtom = hybridEntryInstancesAtom;

// 初始化某一天的条目
export const initDayEntryInstancesAtom = atom(
  null,
  (get, set, dateStr: string) => {
    const map = get(entryInstancesMapAtom);
    if (!map[dateStr]) {
      set(entryInstancesMapAtom, { ...map, [dateStr]: [] });
    }
  }
);

// 创建条目实例
export const createEntryInstanceAtom = atom(
  null,
  (get, set, { instance, dateStr }: { instance: EntryInstance; dateStr: string }) => {
    const map = get(entryInstancesMapAtom);
    const dayInstances = map[dateStr] || [];
    set(entryInstancesMapAtom, {
      ...map,
      [dateStr]: [...dayInstances, instance]
    });
  }
);

// 更新条目实例
export const updateEntryInstanceAtom = atom(
  null,
  (get, set, { instance, dateStr }: { instance: EntryInstance; dateStr: string }) => {
    const map = get(entryInstancesMapAtom);
    const dayInstances = map[dateStr] || [];
    const index = dayInstances.findIndex(i => i.id === instance.id);
    if (index >= 0) {
      const updated = [...dayInstances];
      updated[index] = instance;
      set(entryInstancesMapAtom, { ...map, [dateStr]: updated });
    }
  }
);

// 删除条目实例
export const deleteEntryInstanceAtom = atom(
  null,
  (get, set, { instanceId, dateStr }: { instanceId: string; dateStr: string }) => {
    const map = get(entryInstancesMapAtom);
    const dayInstances = map[dateStr] || [];
    set(entryInstancesMapAtom, {
      ...map,
      [dateStr]: dayInstances.filter(i => i.id !== instanceId)
    });
  }
);

// 计算原子：所有有记录的日期
export const allDaysFilledBySomeEntryInstancesAtom = atom((get) => {
  return Object.keys(get(entryInstancesMapAtom));
});
```

### 4. app.ts - 应用级状态原子

```typescript
// 图表选中日期
export const selectedChartDateAtom = atom<string | null>(null);

// 备份对话框状态
export const backupDialogOpenAtom = atom(false);

// 全局统计状态
export const globalStateAtom = atom<GlobalState>({
  totalDays: 0,
  longestStreak: 0,
  currentStreak: 0,
});

// 图表日期范围
export const chartDateRangeAtom = atom<DateRange>('week');

// 当前主题
export const themeAtom = atomWithStorage('diary-theme', 1);

// 添加对话框状态
export const addDialogOpenAtom = atom(false);
```

### 5. user.ts - 用户认证状态

```typescript
interface GitHubUserState {
  isAuthenticated: boolean;
  user: GitHubUser | null;
  token: string | null;
  isLoading: boolean;
}

export const githubUserStateAtom = atom<GitHubUserState>({
  isAuthenticated: false,
  user: null,
  token: null,
  isLoading: false,
});
```

### 6. uiState.ts - UI 状态原子

```typescript
// UI 状态
export const uiStateAtom = hybridUiStateAtom;

// 设置当前日期
export const initDateStrAtom = atom(
  null,
  (get, set, dateStr: string) => {
    const current = get(uiStateAtom);
    set(uiStateAtom, { ...current, currentDateStr: dateStr });
  }
);

// 进入编辑模式
export const enterEntryTypeEditAtom = atom(
  null,
  (get, set, entryTypeId: string) => {
    const current = get(uiStateAtom);
    set(uiStateAtom, { ...current, editingEntryTypeId: entryTypeId });
  }
);

// 退出编辑模式
export const exitEntryTypeEditAtom = atom(
  null,
  (get, set) => {
    const current = get(uiStateAtom);
    set(uiStateAtom, { ...current, editingEntryTypeId: null });
  }
);
```

### 7. chart.ts - 图表计算原子

```typescript
// 选中日期的总积分
export const selectedTotalPointsAtom = atom((get) => {
  const dateStr = get(selectedChartDateAtom);
  if (!dateStr) return 0;
  const instances = get(entryInstancesMapAtom)[dateStr] || [];
  return instances.reduce((sum, i) => sum + i.points, 0);
});

// 图表数据
export const chartDataAtom = atom((get) => {
  const range = get(chartDateRangeAtom);
  const instancesMap = get(entryInstancesMapAtom);
  // ... 根据日期范围计算图表数据
});
```

## 使用示例

### 读取状态

```typescript
import { useAtomValue } from 'jotai';
import { entryTypesArrayAtom } from '@/atoms';

function MyComponent() {
  const entryTypes = useAtomValue(entryTypesArrayAtom);
  return <div>{entryTypes.map(et => et.title)}</div>;
}
```

### 修改状态

```typescript
import { useSetAtom } from 'jotai';
import { createEntryTypeAtom } from '@/atoms';

function CreateButton() {
  const createEntryType = useSetAtom(createEntryTypeAtom);

  const handleCreate = () => {
    createEntryType({
      id: 'new-habit',
      title: '新习惯',
      defaultPoints: 10,
      // ...
    });
  };

  return <button onClick={handleCreate}>创建</button>;
}
```

### 同时读写

```typescript
import { useAtom } from 'jotai';
import { themeAtom } from '@/atoms';

function ThemeToggle() {
  const [theme, setTheme] = useAtom(themeAtom);
  return (
    <button onClick={() => setTheme(theme === 1 ? 2 : 1)}>
      当前主题: {theme}
    </button>
  );
}
```

## Jotai Store

项目创建了全局 Jotai store 用于组件外访问状态：

```typescript
// src/atoms/index.ts
import { createStore } from 'jotai';
export const jotaiStore = createStore();

// 使用示例（在 React 组件外）
import { jotaiStore, entryTypesArrayAtom } from '@/atoms';
const entryTypes = jotaiStore.get(entryTypesArrayAtom);
```

## localStorage 键名对照表

| 原子 | localStorage 键名 |
|------|-------------------|
| `hybridEntryTypesAtom` | `entryTypes.entryTypesArray` |
| `hybridEntryInstancesAtom` | `entryInstances.entryInstancesMap` |
| `hybridReminderRecordsAtom` | `reminderRecords.reminderRecords` |
| `hybridUiStateAtom` | `uiState.uiState` |
| `themeAtom` | `diary-theme` |
| `legacyLoginUserAtom` | `loginUser.loginUser` |

## 迁移历史

项目原本使用 Redux + Redux Persist，现已完全迁移到 Jotai：

1. **Phase 1**: 创建 Jotai 原子，保持数据结构兼容
2. **Phase 2**: 创建迁移工具 (`stateMigration.ts`)
3. **Phase 3**: 逐个组件迁移到 Jotai
4. **Phase 4**: 移除 Redux 依赖

迁移详情见 `REFACTORING_PLAN.md`。
