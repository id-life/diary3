# 认证系统

项目使用 **GitHub OAuth** 进行用户认证，支持用户登录和数据云备份功能。

## 认证流程概览

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   用户点击   │     │   后端 API   │     │   GitHub     │
│  登录按钮    │────▶│  /auth/github│────▶│   OAuth      │
└──────────────┘     └──────────────┘     └──────────────┘
                                                 │
                                                 ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  保存 Token  │◀────│  回调页面    │◀────│  授权完成    │
│  到本地存储  │     │  提取 Token  │     │  返回 Token  │
└──────────────┘     └──────────────┘     └──────────────┘
```

## 核心文件

| 文件 | 作用 |
|------|------|
| `src/hooks/useGitHubOAuth.ts` | OAuth 登录逻辑 |
| `src/hooks/app.ts` | Token 存储管理 |
| `src/api/auth.ts` | 认证 API 调用 |
| `src/api/request.ts` | Axios 请求配置 |
| `src/atoms/user.ts` | 用户状态原子 |
| `src/components/auth/AuthGuard.tsx` | 路由保护组件 |

## useGitHubOAuth Hook

这是认证系统的核心 Hook：

```typescript
// src/hooks/useGitHubOAuth.ts

export const useGitHubOAuth = () => {
  const [githubUserState, setGithubUserState] = useAtom(githubUserStateAtom);
  const { accessToken, setAccessToken } = useAccessToken();

  // 使用 React Query 获取用户信息
  const userQuery = useQuery({
    queryKey: ['fetch_user_profile', accessToken],
    queryFn: () => getUserProfile(),
    enabled: !!accessToken,  // 只有有 token 时才请求
    retry: (failureCount, error) => {
      if (error?.response?.status === 401) return false;
      return failureCount < 3;
    },
  });

  // 登录：重定向到 GitHub OAuth
  const login = useCallback(() => {
    window.location.href = NEXT_PUBLIC_API_PREFIX + '/auth/github';
  }, []);

  // 登出：清除本地状态
  const logout = () => {
    setAccessToken(null);
    setGithubUserState({
      isAuthenticated: false,
      user: null,
      token: null,
      isLoading: false
    });
  };

  return {
    isAuthenticated: githubUserState.isAuthenticated,
    user: githubUserState.user,
    isLoading: githubUserState.isLoading,
    login,
    logout,
    isRefreshing: userQuery.isFetching,
    isError: userQuery.isError,
  };
};
```

## Token 存储

Token 存储在 localStorage 中，使用自定义存储原子：

```typescript
// src/hooks/app.ts

const localToken = atomWithStorage<string | null>(
  StorageKey.AUTH_TOKEN,  // 'auth_token'
  null,
  {
    getItem: (key) => localStorage.getItem(key),
    setItem: (key, value) => {
      if (value === null) {
        localStorage.removeItem(key);
      } else {
        localStorage.setItem(key, value);
      }
    },
    removeItem: (key) => localStorage.removeItem(key),
  },
  { getOnInit: true }
);

export const useAccessToken = () => {
  const [accessToken, setAccessToken] = useAtom(localToken);
  return { accessToken, setAccessToken };
};
```

## API 请求自动认证

Axios 实例自动为所有请求添加认证头：

```typescript
// src/api/request.ts

const instance = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_PREFIX,
  timeout: 10000,
});

// 请求拦截器：添加 Token
instance.interceptors.request.use((config) => {
  const token = localStorage.getItem(StorageKey.AUTH_TOKEN);
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

## 认证 API

```typescript
// src/api/auth.ts

// 获取用户信息
export const getUserProfile = (): Promise<GitHubUser> => {
  return request.get('/auth/me');
};

// GitHubUser 类型
interface GitHubUser {
  id: number;
  login: string;
  name: string;
  avatar_url: string;
  email: string;
}
```

## 路由保护

使用 `AuthGuard` 组件保护需要认证的路由：

```typescript
// src/components/auth/AuthGuard.tsx

export const AuthGuard = ({ children }: { children: React.ReactNode }) => {
  const { isAuthenticated, isLoading } = useGitHubOAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/login');
    }
  }, [isAuthenticated, isLoading, router]);

  if (isLoading) {
    return <LoadingSpinner />;
  }

  if (!isAuthenticated) {
    return null;
  }

  return <>{children}</>;
};
```

在 App Router 中使用：

```typescript
// src/app/(protected)/layout.tsx

export default function ProtectedLayout({ children }) {
  return <AuthGuard>{children}</AuthGuard>;
}
```

## OAuth 回调处理

OAuth 认证完成后，后端会重定向到首页并带上 token 参数：

```typescript
// src/app/(protected)/page.tsx (HomePageContent)

useEffect(() => {
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  if (token) {
    setAccessToken(token);
    // 清除 URL 中的 token 参数
    window.history.replaceState({}, '', '/');
  }
}, []);
```

## 用户状态原子

```typescript
// src/atoms/user.ts

interface GitHubUserState {
  isAuthenticated: boolean;
  user: GitHubUser | null;
  token: string | null;
  isLoading: boolean;
}

export const githubUserStateAtom = atom<GitHubUserState>({
  isAuthenticated: false,
  user: null,
  token: null,
  isLoading: false,
});
```

## 登录页面

```typescript
// src/app/login/page.tsx

export default function LoginPage() {
  const { login, isAuthenticated } = useGitHubOAuth();
  const router = useRouter();

  useEffect(() => {
    if (isAuthenticated) {
      router.push('/');
    }
  }, [isAuthenticated]);

  return (
    <div>
      <h1>登录</h1>
      <button onClick={login}>
        <GitHubIcon />
        使用 GitHub 登录
      </button>
    </div>
  );
}
```

## 认证状态流转图

```
初始状态
    │
    ▼
┌─────────────────┐
│ isAuthenticated │
│ = false         │
│ isLoading=false │
└────────┬────────┘
         │ 用户点击登录
         ▼
┌─────────────────┐
│ 重定向到 GitHub │
│ OAuth 页面      │
└────────┬────────┘
         │ 用户授权
         ▼
┌─────────────────┐
│ 回调返回 token  │
│ 保存到 storage  │
└────────┬────────┘
         │ 触发 userQuery
         ▼
┌─────────────────┐
│ isLoading=true  │
│ 请求用户信息    │
└────────┬────────┘
         │ 请求成功
         ▼
┌─────────────────┐
│ isAuthenticated │
│ = true          │
│ user = {...}    │
└─────────────────┘
```

## 安全注意事项

1. **Token 存储**：Token 存储在 localStorage，可能受 XSS 攻击影响
2. **HTTPS**：生产环境务必使用 HTTPS
3. **Token 过期**：后端应实现 Token 过期机制
4. **401 处理**：收到 401 响应时自动登出

## 环境变量

```bash
NEXT_PUBLIC_API_PREFIX=https://diary-api.id.life
```

## 相关后端接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/auth/github` | GET | 发起 OAuth 认证 |
| `/auth/me` | GET | 获取当前用户信息 |
| `/github-backups` | GET/POST | 数据备份接口 |
