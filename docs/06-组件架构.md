# 组件架构

## 组件目录结构

```
src/components/
├── app/                    # 应用级组件
├── auth/                   # 认证相关组件
├── entry/                  # 日记条目组件（核心）
├── reminder/               # 提醒功能组件
├── dialog/                 # 对话框组件
├── data/                   # 数据管理组件
├── layout/                 # 布局组件
├── ui/                     # Shadcn UI 基础组件
└── common/                 # 通用工具组件
```

## 页面布局结构

### 根布局 (src/app/layout.tsx)

```
RootLayout
├── <html>
│   └── <body>
│       └── Providers (Jotai + React Query)
│           └── <main id="main">
│               ├── ErrorBoundary
│               │   └── {children} (页面内容)
│               ├── ClientOnly
│               │   └── Navbar (底部导航)
│               ├── DialogComponents (全局对话框)
│               └── ToastContainer (通知)
```

### 受保护路由布局 (src/app/(protected)/layout.tsx)

```
ProtectedLayout
└── AuthGuard
    └── {children}
```

## 核心组件详解

### 1. Entry 组件群（日记条目）

#### EntryPageContent

主页面容器，组合所有日记相关组件：

```
EntryPageContent
├── EntryHeader
│   ├── 日期选择器
│   └── EntryProgressBar (今日进度)
├── EntryChart (图表区域)
├── EntryInstanceList (今日记录列表)
└── EntryTypeListForCompletion (可完成的习惯列表)
```

#### EntryChart

使用 Recharts 展示数据可视化：

```typescript
// 主要功能
- 展示每日/每周/每月积分统计
- 柱状图可点击选中日期
- 颜色根据积分高低变化
- 响应 chartDateRangeAtom 切换时间范围
```

#### EntryTypeForm

习惯类型编辑表单：

```typescript
// 表单字段
- id: 习惯标识符
- title: 显示名称
- defaultPoints: 默认积分
- pointStep: 积分步长
- routine: 重复周期 (Daily/Weekly/Monthly/Adhoc)
- themeColors: 主题颜色选择
```

#### EntryInstanceForm

条目实例编辑表单：

```typescript
// 表单字段
- points: 本次积分
- notes: 备注
- createdAt: 创建时间（可调整）
```

#### StreaksContainer

连续记录展示容器：

```
StreaksContainer
├── 周期筛选器 (Daily/Weekly/Monthly/Adhoc)
└── EntryStreakCard[] (每个习惯的连续记录卡片)
```

### 2. Reminder 组件群（提醒）

#### ReminderRecords

提醒记录列表：

```
ReminderRecords
└── ReminderRecordCard[] (每个提醒卡片)
    ├── 标题
    ├── 提醒类型
    ├── 触发时间
    └── 操作按钮 (编辑/删除)
```

#### ReminderAddForm

提醒编辑表单：

```typescript
// 表单字段
- title: 提醒标题
- content: 提醒内容
- type: 提醒类型 (Weekly/Monthly/Annual/Since)
- weekDay: 周几 (Weekly 类型)
- monthDay: 几号 (Monthly 类型)
- month: 几月 (Annual 类型)
- sinceStartTime: 开始时间 (Since 类型)
```

### 3. Layout 组件

#### Navbar

底部导航栏：

```typescript
// 导航项
const navItems = [
  { path: '/entry', icon: HomeIcon, label: 'Entry' },
  { path: '/add', icon: PlusIcon, label: 'Add' },
  { path: '/add-entry', icon: AddCircleIcon, label: '' }, // 浮动按钮
  { path: '/reminder', icon: BellIcon, label: 'Reminder' },
  { path: '/settings', icon: SettingsIcon, label: 'Settings' },
];
```

### 4. Auth 组件

#### AuthGuard

路由保护包装器：

```typescript
const AuthGuard = ({ children }) => {
  const { isAuthenticated, isLoading } = useGitHubOAuth();

  if (isLoading) return <Loading />;
  if (!isAuthenticated) {
    redirect('/login');
    return null;
  }
  return children;
};
```

### 5. Dialog 组件

#### DialogComponents

全局对话框管理：

```typescript
// 包含的对话框
- AddDialog (添加条目对话框)
- BackupDialog (备份管理对话框)
- DataExportDialog (数据导出对话框)
```

#### AddDialog

快速添加条目的弹窗：

```
AddDialog
├── 习惯类型选择列表
└── EntryTypeCompletionForm (选中后的快速完成表单)
```

### 6. Common 组件

#### ClientOnly

确保组件只在客户端渲染：

```typescript
const ClientOnly = ({ children }) => {
  const [mounted, setMounted] = useState(false);
  useEffect(() => setMounted(true), []);
  if (!mounted) return null;
  return children;
};
```

#### ErrorBoundary

错误边界组件：

```typescript
<ErrorBoundary fallback={<ErrorFallback />}>
  {children}
</ErrorBoundary>
```

### 7. UI 组件（Shadcn）

基于 Radix UI 的基础组件库：

| 组件 | 用途 |
|------|------|
| `Button` | 按钮 |
| `Input` | 输入框 |
| `Card` | 卡片容器 |
| `Form` | 表单相关 |
| `Label` | 标签 |
| `Switch` | 开关 |
| `Popover` | 弹出层 |
| `Calendar` | 日历 |
| `DatePicker` | 日期选择器 |

## 组件通信模式

### 1. Jotai 状态共享

```typescript
// 父组件设置状态
const setSelectedDate = useSetAtom(selectedChartDateAtom);
setSelectedDate('2024-01-15');

// 子组件读取状态
const selectedDate = useAtomValue(selectedChartDateAtom);
```

### 2. Props 传递

```typescript
<EntryTypeCard
  entryType={entryType}
  onEdit={() => handleEdit(entryType.id)}
  onDelete={() => handleDelete(entryType.id)}
/>
```

### 3. React Context

主要用于 Provider 配置：

```typescript
// src/providers/root.tsx
<QueryClientProvider client={queryClient}>
  <JotaiProvider store={jotaiStore}>
    {children}
  </JotaiProvider>
</QueryClientProvider>
```

## 表单处理模式

使用 React Hook Form + Zod：

```typescript
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const schema = z.object({
  title: z.string().min(1, '标题不能为空'),
  points: z.number().min(0, '积分不能为负'),
});

function MyForm() {
  const form = useForm({
    resolver: zodResolver(schema),
    defaultValues: { title: '', points: 0 },
  });

  const onSubmit = (data) => {
    // 处理提交
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)}>
        {/* 表单字段 */}
      </form>
    </Form>
  );
}
```

## 样式方案

### Tailwind CSS

```typescript
// 使用 cn() 工具函数合并类名
import { cn } from '@/utils';

<div className={cn(
  'p-4 rounded-lg',
  isActive && 'bg-blue-500',
  className
)} />
```

### 主题渐变

```typescript
// 使用 themeColors 生成渐变
const gradient = `linear-gradient(135deg, #${color1}, #${color2})`;
```

## 性能优化

### 1. 组件懒加载

```typescript
const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <Skeleton />,
});
```

### 2. 计算原子缓存

```typescript
// 派生数据使用计算原子，自动缓存
const totalPointsAtom = atom((get) => {
  const instances = get(entryInstancesMapAtom);
  // 只有依赖变化时才重新计算
  return calculateTotal(instances);
});
```

### 3. ClientOnly 避免 hydration 问题

```typescript
<ClientOnly>
  <ComponentWithLocalStorage />
</ClientOnly>
```
